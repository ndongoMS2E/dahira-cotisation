<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cotisation - Diamyatoul Birri Wal Islah</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a472a 0%, #2d5016 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 400px; margin: 0 auto; }

        /* Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
            border-radius: 50%;
            object-fit: cover;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 15px;
        }

        /* Member Info */
        .member-info {
            background: linear-gradient(135deg, #006400, #228B22);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
        }

        .member-info .numero {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .member-info .nom {
            font-size: 18px;
            font-weight: 700;
        }

        .member-info .tel {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Section Title */
        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            margin-top: 15px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* Type Selection */
        .type-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .type-btn {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .type-btn:hover { border-color: #228B22; }

        .type-btn.active {
            border-color: #006400;
            background: #e8f5e9;
        }

        .type-btn .icon { font-size: 24px; margin-bottom: 5px; }
        .type-btn .label { font-size: 11px; font-weight: 600; color: #333; }

        /* Grid pour mois et √©v√©nements */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .grid-btn {
            padding: 12px 5px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-btn:hover {
            border-color: #228B22;
            background: #f5fff5;
        }

        .grid-btn.selected {
            border-color: #006400;
            background: #006400;
            color: white;
        }

        /* Hidden */
        .hidden { display: none !important; }

        /* Info Box */
        .info-box {
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 11px;
            color: #2e7d32;
            text-align: center;
        }

        /* Pay Button */
        .pay-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #1DC4E9 0%, #1BA4C4 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .pay-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(29, 196, 233, 0.4);
        }

        .pay-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Footer */
        .footer {
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-size: 11px;
            margin-top: 20px;
        }

        /* Alert */
        .alert {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .alert.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .alert.hidden {
            display: none;
        }

        /* R√©sum√© s√©lection */
        .selection-summary {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .selection-summary .label {
            font-size: 10px;
            color: #666;
            margin-bottom: 3px;
        }

        .selection-summary .value {
            font-size: 13px;
            font-weight: 700;
            color: #006400;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="logo.png" alt="Logo" class="logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIj48Y2lyY2xlIGN4PSI0MCIgY3k9IjQwIiByPSI0MCIgZmlsbD0iIzAwNjQwMCIvPjx0ZXh0IHg9IjQwIiB5PSI0OCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC13ZWlnaHQ9ImJvbGQiPkRCV0k8L3RleHQ+PC9zdmc+'">
            <h1>DIAMYATOUL BIRRI WAL ISLAH</h1>
            <p>Syst√®me de cotisation</p>
        </div>

        <!-- Main Card -->
        <div class="card">
            <!-- Alert -->
            <div id="alert" class="alert error hidden"></div>

            <!-- Member Info -->
            <div class="member-info">
                <div class="numero" id="displayNumero">N¬∞ ---</div>
                <div class="nom" id="displayNom">Chargement...</div>
                <div class="tel" id="displayTel">üìû ---</div>
            </div>

            <!-- Type Selection -->
            <p class="section-title">üìã Type de cotisation</p>
            <div class="type-buttons">
                <div class="type-btn active" data-type="mensuelle" onclick="selectType('mensuelle')">
                    <div class="icon">üìÖ</div>
                    <div class="label">Mensuelle</div>
                </div>
                <div class="type-btn" data-type="khitma" onclick="selectType('khitma')">
                    <div class="icon">üìñ</div>
                    <div class="label">Khitma</div>
                </div>
            </div>

            <!-- Section Mensuelle -->
            <div id="sectionMensuelle">
                <p class="section-title">S√©lectionner le(s) mois</p>
                <div class="selection-grid" id="monthsGrid"></div>
            </div>

            <!-- Section Khitma -->
            <div id="sectionKhitma" class="hidden">
                <p class="section-title">S√©lectionner l'√©v√©nement</p>
                <div class="selection-grid" id="khitmaGrid"></div>
            </div>

            <!-- R√©sum√© -->
            <div class="selection-summary">
                <div class="label">Votre s√©lection</div>
                <div class="value" id="summaryText">Aucune s√©lection</div>
            </div>

            <!-- Info -->
            <div class="info-box">
                ‚ÑπÔ∏è Vous serez redirig√© vers Wave pour saisir le montant et effectuer le paiement.
            </div>

            <!-- Pay Button -->
            <button class="pay-btn" id="payBtn" onclick="payerAvecWave()" disabled>
                üí≥ Payer avec Wave
            </button>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Diamyatoul Birri Wal Islah</p>
            <p>Contact: 778788709 / 771751732</p>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbymM-ba_VVcqrtq7-iiCMnEXSVC8S33whoBg908ha8Qps5b1TgjlCYN6dbAoVz4MFQP/exec',
            WAVE_LINK: 'https://pay.wave.com/m/M_sn_0WdGh370xGcP/c/sn/'
        };

        // ========== DONN√âES ==========
        const mois = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        
        const evenements = [
            'Gamou Taiba',
            'Ziarre Baye',
            'Keur Assane',
            'Soukeur Koor',
            'Tabaski',
            'Ziarre Tamkharite',
            'Maolid',
            'Appel de Baye'
        ];

        // ========== VARIABLES ==========
        let membre = {
            numero: '',
            prenom: '',
            nom: '',
            telephone: ''
        };
        let selectedType = 'mensuelle';
        let selectedMonths = [];
        let selectedKhitma = null;

        // ========== INITIALISATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            
            // R√©cup√©rer le num√©ro (accepte: numero, membre, id)
            membre.numero = urlParams.get('numero') || urlParams.get('membre') || urlParams.get('id') || '';
            
            // R√©cup√©rer pr√©nom et nom
            membre.prenom = urlParams.get('prenom') || '';
            membre.nom = urlParams.get('nom') || '';
            
            // R√©cup√©rer t√©l√©phone (accepte: tel, telephone)
            membre.telephone = urlParams.get('tel') || urlParams.get('telephone') || '';
            
            // V√©rifier si on a les infos n√©cessaires
            if (!membre.numero && !membre.prenom && !membre.nom) {
                showAlert('Informations du membre manquantes. Veuillez scanner le QR code de votre carte.');
                document.getElementById('displayNom').textContent = 'Membre non identifi√©';
            } else {
                // Afficher les infos du membre
                document.getElementById('displayNumero').textContent = membre.numero ? 'N¬∞ ' + membre.numero : '';
                document.getElementById('displayNom').textContent = (membre.prenom + ' ' + membre.nom).trim() || 'Membre';
                document.getElementById('displayTel').textContent = membre.telephone ? 'üìû ' + membre.telephone : '';
            }
            
            genererMoisGrid();
            genererKhitmaGrid();
        });

        // ========== G√âN√âRER GRILLE DES MOIS ==========
        function genererMoisGrid() {
            const grid = document.getElementById('monthsGrid');
            const annee = new Date().getFullYear();
            
            grid.innerHTML = mois.map((m, i) => `
                <button type="button" class="grid-btn" data-month="${i+1}" onclick="toggleMonth(this, ${i+1})">
                    ${m.substring(0, 3)}
                </button>
            `).join('');
        }

        // ========== G√âN√âRER GRILLE DES √âV√âNEMENTS ==========
        function genererKhitmaGrid() {
            const grid = document.getElementById('khitmaGrid');
            
            grid.innerHTML = evenements.map(evt => `
                <button type="button" class="grid-btn" data-event="${evt}" onclick="selectKhitma(this, '${evt}')">
                    ${evt}
                </button>
            `).join('');
        }

        // ========== S√âLECTIONNER TYPE ==========
        function selectType(type) {
            selectedType = type;
            
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            document.getElementById('sectionMensuelle').classList.toggle('hidden', type !== 'mensuelle');
            document.getElementById('sectionKhitma').classList.toggle('hidden', type !== 'khitma');
            
            // Reset
            selectedMonths = [];
            selectedKhitma = null;
            document.querySelectorAll('.grid-btn').forEach(btn => btn.classList.remove('selected'));
            
            updateSummary();
        }

        // ========== TOGGLE MOIS ==========
        function toggleMonth(btn, month) {
            btn.classList.toggle('selected');
            
            if (btn.classList.contains('selected')) {
                selectedMonths.push(month);
            } else {
                selectedMonths = selectedMonths.filter(m => m !== month);
            }
            
            updateSummary();
        }

        // ========== S√âLECTIONNER KHITMA ==========
        function selectKhitma(btn, event) {
            document.querySelectorAll('#khitmaGrid .grid-btn').forEach(b => b.classList.remove('selected'));
            
            btn.classList.add('selected');
            selectedKhitma = event;
            
            updateSummary();
        }

        // ========== METTRE √Ä JOUR R√âSUM√â ==========
        function updateSummary() {
            const summaryText = document.getElementById('summaryText');
            let text = 'Aucune s√©lection';
            let isValid = false;
            
            if (selectedType === 'mensuelle' && selectedMonths.length > 0) {
                const annee = new Date().getFullYear();
                const moisNoms = selectedMonths.sort((a,b) => a-b).map(m => mois[m-1]).join(', ');
                text = moisNoms + ' ' + annee;
                isValid = true;
            } else if (selectedType === 'khitma' && selectedKhitma) {
                text = selectedKhitma;
                isValid = true;
            }
            
            summaryText.textContent = text;
            document.getElementById('payBtn').disabled = !isValid;
        }

        // ========== PAYER AVEC WAVE ==========
        async function payerAvecWave() {
            let detail = '';
            const annee = new Date().getFullYear();
            
            if (selectedType === 'mensuelle') {
                detail = selectedMonths.sort((a,b) => a-b).map(m => mois[m-1] + ' ' + annee).join(', ');
            } else {
                detail = selectedKhitma;
            }
            
            // Pr√©parer les donn√©es
            const cotisationData = {
                numero_carte: membre.numero,
                prenom: membre.prenom,
                nom: membre.nom,
                telephone: membre.telephone,
                type: selectedType,
                detail: detail,
                date: new Date().toISOString(),
                statut: 'en_attente'
            };
            
            try {
                // Enregistrer dans Google Sheets
                await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'create', data: cotisationData })
                });
                
                console.log('Cotisation enregistr√©e:', cotisationData);
            } catch (error) {
                console.error('Erreur:', error);
            }
            
            // Rediriger vers Wave
            window.location.href = CONFIG.WAVE_LINK;
        }

        // ========== AFFICHER ALERTE ==========
        function showAlert(message) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.classList.remove('hidden');
        }
    </script>
</body>
</html>